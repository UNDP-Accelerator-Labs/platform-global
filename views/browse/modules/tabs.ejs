<%
	// CREATE ALIASES
	const modules = locals.metadata.site.modules
	const space = locals.metadata.page.space
	const object = locals.metadata.page.object
	const query = locals.metadata.page.query
	const language = locals.metadata.page.language
	const rights = locals.metadata.user.rights

%>

<menu>
		
		<% if (modules.some(d => d.type === 'pinboards' && rights >= d.rights.read) 
			&& locals.pinboards_list?.length) 
		{ %>
			<li class='filter <% if (space === "pinned") { %>active<% } %>'>
				<div class='inner'>
					<input type='text' id='pinboards' onblur='fixLabel(this)'>
					<label for='pindboards'><%- vocabulary['space'][language](object, 'pinned') %><span class='count'><%- locals.pinboards_list?.length ?? 0 %></span></label>
				</div>

				<div id='pinboards-list' class='dropdown'>
					<menu>
						<% locals.pinboards_list.filter(d => d.id !== locals.pinboard?.id)
						.forEach(d => { %>
							<li>
								<a href='./pinned?pinboard=<%- d.id %>'><%- d.title %></a>
							</li>
						<% }) %>
					</menu>
				</div>
			</li>
		<% } %>
		<li class='<% if (space === "shared") { %>active<% } %>'>
			<a onclick='redirect("./shared")'>
				<button><%- vocabulary['space'][language](object, 'shared') %>
					<div class='count'><%- locals.global_info?.shared %></div>
				</button>
			</a>
		</li>
		
		<% if (!['reviews', 'templates'].includes(object)) { %>
			<li class='<% if (space === "public") { %>active<% } %>'>
				<a onclick='redirect("./public")'>
					<button><%- vocabulary['space'][language](object, 'public') %>
						<div class='count'><%- locals.global_info?.public %></div>
					</button>
				</a>
			</li>
		<% } %>
</menu>

<% if (space === 'pinned' && locals.pinboard) { %>
<script type='text/javascript'>
	function updateTab (value) {
		if (!mediaSize) var mediaSize = getMediaSize()
		const input = d3.select(`.${mediaSize} input[type=text]#pinboards`).node()
		if (input) {
			if (value.length > 25) value = `${value.slice(0, 25)}â€¦`
			input.value = value
			fixLabel(input)
		}
	}
	updateTab('<%- locals.pinboard.title %>')
</script>
<% } %>
<script type='text/javascript'>
	function redirect (location) {
		const url = new URL(window.location)
		const queryparams = new URLSearchParams(url.search)
		const filter_keys = <%- JSON.stringify(Object.keys(query)?.filter(key => !['status', 'mapscale', 'display'].includes(key))) %>

		// <% if (locals.global_info.filters_menu?.length) { %>
		// 	const filter_keys = Object.keys((<%- JSON.stringify(locals.global_info.filters_menu) %>).flatObj())
		// <% } else { %>
		// 	const filter_keys = []
		// <% } %>
		
		filter_keys.push('search')
		filter_keys.push('source') // THIS IS SPECIFIC TO THE GLOBAL PLATFORM (OR TO A MULTI-SOURCE PLATFORM)
		for (const key of queryparams.keys()) {
			if (!filter_keys.includes(key)) queryparams.delete(key)
		}		
		return window.location = `${location}?${queryparams.toString()}`
	}
</script>